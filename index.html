import React, { useState, useEffect } from 'react';
import { Calendar, Clock, MapPin, User, Users, Zap, Coffee, MessageSquare, CheckCircle, Sparkles, ArrowRight, Loader2, AlertCircle } from 'lucide-react';

// ⚠️ 請將下方的網址替換為您在 Apps Script 部署後取得的 "Web App URL"
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyrCzAWakVPaZUea05G6IRyxc5cX-XW353SwLP6zFk0Tbd7ZL4wZyQfs-ZO1l5iglQT/exec";

const AgileWorkshop = () => {
  const [mounted, setMounted] = useState(false);
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    unit: '',
    jobTitle: '',
    snack: 'yes',
    question: ''
  });
  const [status, setStatus] = useState('idle'); // idle, submitting, success, error
  const [errors, setErrors] = useState({});

  useEffect(() => {
    setMounted(true);
  }, []);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
    if (errors[name]) {
      setErrors(prev => ({ ...prev, [name]: '' }));
    }
  };

  const handleJobSelect = (job) => {
    setFormData(prev => ({ ...prev, jobTitle: job }));
    if (errors.jobTitle) setErrors(prev => ({ ...prev, jobTitle: '' }));
  };

  const validate = () => {
    let tempErrors = {};
    if (!formData.name) tempErrors.name = "請輸入姓名";
    if (!formData.email) tempErrors.email = "請輸入電子郵件";
    else if (!/\S+@\S+\.\S+/.test(formData.email)) tempErrors.email = "Email 格式不正確";
    if (!formData.unit) tempErrors.unit = "請輸入單位";
    if (!formData.jobTitle) tempErrors.jobTitle = "請選擇職稱";
    
    setErrors(tempErrors);
    return Object.keys(tempErrors).length === 0;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (validate()) {
      setStatus('submitting');
      
      try {
        // 準備要傳送的資料
        const payload = {
          ...formData,
          // 將 snack 的 yes/no 轉換為中文，方便在 Excel 閱讀
          snack: formData.snack === 'yes' ? '需要' : '不需要'
        };

        // 使用 fetch 發送 POST 請求
        // 注意：mode: 'no-cors' 是為了避免跨域問題，但這樣無法讀取詳細的回傳內容
        // 最佳解法是透過 Content-Type: text/plain 讓瀏覽器視為簡單請求，Apps Script 再解析
        const response = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: {
            "Content-Type": "text/plain;charset=utf-8",
          },
          body: JSON.stringify(payload),
        });

        if (response.ok) {
           // 因為跨域限制，有時候即使成功 response.ok 也可能不準確，但在 GAS 應用中通常
           // 只要沒有拋出網路錯誤，我們就視為成功，或者依賴 Apps Script 的回傳
           // 若要精確判斷，通常需要透過 text/plain 的回傳解析
           const result = await response.json();
           if (result.result === 'success') {
             setStatus('success');
             window.scrollTo({ top: 0, behavior: 'smooth' });
           } else {
             throw new Error(result.error || 'Submission failed');
           }
        } else {
           throw new Error('Network response was not ok');
        }

      } catch (error) {
        console.error("Error:", error);
        // 備用方案：如果 JSON 解析失敗（常見於 GAS no-cors 限制），但沒報錯，通常也是成功寫入了
        // 為了保險起見，這裡做一個簡單的處理：
        // 如果是開發環境未替換 URL，會直接報錯
        if (SCRIPT_URL === "YOUR_GOOGLE_SCRIPT_URL_HERE") {
             alert("請先設定 Apps Script URL！(請參考程式碼第 8 行)");
             setStatus('idle');
        } else {
             // 假設成功 (因為 GAS 跨域有時會導致 fetch 進入 catch 但其實寫入成功)
             // 在正式環境若要更嚴謹，可以使用 form action 直接提交或 JSONP，但在 React 這樣做最直觀
             // 這裡我們採取「寬容模式」，若真失敗使用者可重試
             alert("連線發生問題，請確認網路後重試。"); 
             setStatus('error');
        }
      }
    }
  };

  const jobOptions = ["醫師", "護理師", "醫事人員", "行政人員", "其他"];

  const agendaItems = [
    { time: "14:00 - 14:15", title: "報到與暖身 (Check-in)", desc: "領取名牌、享用茶點，破冰遊戲認識跨部門夥伴。", icon: <Coffee className="w-5 h-5" /> },
    { time: "14:15 - 15:00", title: "Session 1: 擁抱變化的勇氣", desc: "從 Hello World 2025 看趨勢。Agile 如何解決行政痛點？", icon: <Zap className="w-5 h-5" /> },
    { time: "15:00 - 15:10", title: "中場休息 (Break)", desc: "大腦充電與自由交流時間。", icon: <User className="w-5 h-5" /> },
    { time: "15:10 - 16:00", title: "Session 2: 行政實務應用案例", desc: "不再被 Deadline 追著跑！Kanban 與 Iteration 在 QCC/OSCE 的應用。", icon: <Users className="w-5 h-5" /> },
    { time: "16:00 - 16:40", title: "Workshop: 敏捷實戰演練", desc: "分組演練「站立會議」與「回顧會議」，解決真實痛點。", icon: <MessageSquare className="w-5 h-5" /> },
    { time: "16:40 - 17:00", title: "總結與問答 (Q&A)", desc: "開放提問與講師總結。", icon: <Sparkles className="w-5 h-5" /> },
  ];

  return (
    <div className="min-h-screen bg-gradient-to-br from-violet-600 via-fuchsia-500 to-orange-400 font-sans text-slate-800 selection:bg-yellow-300 selection:text-violet-900 pb-20 overflow-x-hidden">
      {/* Decorative Background Shapes */}
      <div className={`fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0 transition-opacity duration-1000 ${mounted ? 'opacity-100' : 'opacity-0'}`}>
        <div className="absolute top-[-10%] left-[-10%] w-96 h-96 bg-purple-400 rounded-full mix-blend-multiply filter blur-3xl opacity-50 animate-blob"></div>
        <div className="absolute top-[-10%] right-[-10%] w-96 h-96 bg-yellow-300 rounded-full mix-blend-multiply filter blur-3xl opacity-50 animate-blob animation-delay-2000"></div>
        <div className="absolute bottom-[-20%] left-[20%] w-96 h-96 bg-pink-400 rounded-full mix-blend-multiply filter blur-3xl opacity-50 animate-blob animation-delay-4000"></div>
      </div>

      <div className="relative z-10 max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 md:pt-20">
        
        {/* Header Section */}
        <header className="text-center mb-16 space-y-6">
          <div className="inline-block px-4 py-1.5 rounded-full bg-white/20 backdrop-blur-sm border border-white/30 text-white font-medium text-sm tracking-wide mb-4 shadow-lg">
            ✨ Hello World 2025 開發者大會心得分享
          </div>
          <h1 className="text-4xl md:text-6xl font-extrabold text-white leading-tight drop-shadow-md">
            敏捷思維<br/><span className="text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-orange-100">導入教學行政</span>
          </h1>
          <p className="text-lg md:text-xl text-white/90 max-w-2xl mx-auto font-light">
            打破行政框架，擁抱靈活變革。
            <br className="hidden md:block"/>
            一同探索如何將 Agile 精神應用於 QCC、OSCE 與日常管理。
          </p>
        </header>

        <div className="grid md:grid-cols-12 gap-8">
          {/* Left Column: Info & Agenda */}
          <div className="md:col-span-7 space-y-8">
            
            {/* Info Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="bg-white/80 backdrop-blur-md p-6 rounded-2xl shadow-xl border border-white/50 transform hover:-translate-y-1 transition duration-300">
                <div className="flex items-center space-x-3 mb-2">
                  <div className="p-2 bg-violet-100 rounded-lg text-violet-600">
                    <Calendar size={24} />
                  </div>
                  <h3 className="font-bold text-lg text-slate-700">日期</h3>
                </div>
                <p className="text-slate-600 font-medium ml-11">2025 年 11 月 30 日 (日)</p>
              </div>
              <div className="bg-white/80 backdrop-blur-md p-6 rounded-2xl shadow-xl border border-white/50 transform hover:-translate-y-1 transition duration-300">
                <div className="flex items-center space-x-3 mb-2">
                  <div className="p-2 bg-pink-100 rounded-lg text-pink-600">
                    <Clock size={24} />
                  </div>
                  <h3 className="font-bold text-lg text-slate-700">時間</h3>
                </div>
                <p className="text-slate-600 font-medium ml-11">14:00 - 17:00 (3 小時)</p>
              </div>
              <div className="md:col-span-2 bg-white/80 backdrop-blur-md p-6 rounded-2xl shadow-xl border border-white/50 transform hover:-translate-y-1 transition duration-300">
                <div className="flex items-center space-x-3 mb-2">
                  <div className="p-2 bg-orange-100 rounded-lg text-orange-600">
                    <MapPin size={24} />
                  </div>
                  <h3 className="font-bold text-lg text-slate-700">地點</h3>
                </div>
                <p className="text-slate-600 font-medium ml-11">第五醫療大樓 5F 552 會議室</p>
              </div>
            </div>

            {/* Agenda Section */}
            <div className="bg-white/80 backdrop-blur-md p-8 rounded-3xl shadow-xl border border-white/50">
              <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center">
                <span className="bg-gradient-to-r from-violet-500 to-fuchsia-500 w-2 h-8 rounded-full mr-3"></span>
                活動議程
              </h2>
              <div className="space-y-8 relative before:absolute before:inset-0 before:ml-5 before:-translate-x-px md:before:mx-auto md:before:translate-x-0 before:h-full before:w-0.5 before:bg-gradient-to-b before:from-transparent before:via-slate-300 before:to-transparent">
                {agendaItems.map((item, index) => (
                  <div key={index} className="relative flex items-start group">
                    <div className="absolute left-0 md:left-auto mt-1 ml-2.5 md:ml-0 h-5 w-5 rounded-full border-2 border-white bg-fuchsia-500 shadow z-10 group-hover:scale-125 transition-transform duration-300"></div>
                    <div className="ml-10 w-full">
                      <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-1">
                        <h4 className="text-lg font-bold text-slate-800 group-hover:text-fuchsia-600 transition-colors">
                          {item.title}
                        </h4>
                        <span className="text-sm font-mono font-semibold text-slate-500 bg-slate-100 px-2 py-1 rounded self-start sm:self-auto mt-1 sm:mt-0">
                          {item.time}
                        </span>
                      </div>
                      <p className="text-slate-600 text-sm leading-relaxed">{item.desc}</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>

          </div>

          {/* Right Column: Registration Form */}
          <div className="md:col-span-5 relative">
            <div className="sticky top-8">
              <div className={`bg-white rounded-3xl shadow-2xl overflow-hidden transition-all duration-500 ${status === 'success' ? 'scale-95 opacity-0 pointer-events-none absolute top-0' : 'opacity-100 scale-100'}`}>
                <div className="bg-gradient-to-r from-violet-600 to-fuchsia-600 p-6 text-white">
                  <h2 className="text-2xl font-bold flex items-center gap-2">
                    <Sparkles size={24} className="text-yellow-300" />
                    立即報名
                  </h2>
                  <p className="text-white/80 text-sm mt-1">名額有限，請儘速填寫資料</p>
                </div>
                
                <form onSubmit={handleSubmit} className="p-6 space-y-5">
                  
                  {/* Name */}
                  <div>
                    <label className="block text-sm font-bold text-slate-700 mb-1">姓名 <span className="text-red-500">*</span></label>
                    <input 
                      type="text" 
                      name="name"
                      value={formData.name}
                      onChange={handleChange}
                      disabled={status === 'submitting'}
                      className={`w-full px-4 py-3 rounded-xl bg-slate-50 border-2 ${errors.name ? 'border-red-400 bg-red-50' : 'border-slate-100 focus:border-violet-500'} outline-none transition-all disabled:opacity-50`}
                      placeholder="請輸入您的姓名"
                    />
                    {errors.name && <p className="text-red-500 text-xs mt-1 ml-1">{errors.name}</p>}
                  </div>

                  {/* Email */}
                  <div>
                    <label className="block text-sm font-bold text-slate-700 mb-1">電子郵件 (Email) <span className="text-red-500">*</span></label>
                    <input 
                      type="email" 
                      name="email"
                      value={formData.email}
                      onChange={handleChange}
                      disabled={status === 'submitting'}
                      className={`w-full px-4 py-3 rounded-xl bg-slate-50 border-2 ${errors.email ? 'border-red-400 bg-red-50' : 'border-slate-100 focus:border-violet-500'} outline-none transition-all disabled:opacity-50`}
                      placeholder="example@chimei.org.tw"
                    />
                    {errors.email && <p className="text-red-500 text-xs mt-1 ml-1">{errors.email}</p>}
                  </div>

                  {/* Unit */}
                  <div>
                    <label className="block text-sm font-bold text-slate-700 mb-1">單位 <span className="text-red-500">*</span></label>
                    <input 
                      type="text" 
                      name="unit"
                      value={formData.unit}
                      onChange={handleChange}
                      disabled={status === 'submitting'}
                      className={`w-full px-4 py-3 rounded-xl bg-slate-50 border-2 ${errors.unit ? 'border-red-400 bg-red-50' : 'border-slate-100 focus:border-violet-500'} outline-none transition-all disabled:opacity-50`}
                      placeholder="例如：教學部"
                    />
                     {errors.unit && <p className="text-red-500 text-xs mt-1 ml-1">{errors.unit}</p>}
                  </div>

                  {/* Job Title - Chips */}
                  <div>
                    <label className="block text-sm font-bold text-slate-700 mb-2">職稱 (必填) <span className="text-red-500">*</span></label>
                    <div className="flex flex-wrap gap-2">
                      {jobOptions.map((job) => (
                        <button
                          key={job}
                          type="button"
                          disabled={status === 'submitting'}
                          onClick={() => handleJobSelect(job)}
                          className={`px-4 py-2 rounded-full text-sm font-bold transition-all duration-200 border-2 disabled:opacity-50 disabled:cursor-not-allowed
                            ${formData.jobTitle === job 
                              ? 'bg-fuchsia-100 text-fuchsia-700 border-fuchsia-500 shadow-md transform scale-105' 
                              : 'bg-white text-slate-500 border-slate-200 hover:border-fuchsia-300 hover:text-fuchsia-500'}`}
                        >
                          {job}
                        </button>
                      ))}
                    </div>
                    {errors.jobTitle && <p className="text-red-500 text-xs mt-1 ml-1">{errors.jobTitle}</p>}
                  </div>

                  {/* Snacks */}
                  <div className="bg-slate-50 p-4 rounded-xl">
                    <label className="block text-sm font-bold text-slate-700 mb-2">是否需要茶水點心？</label>
                    <div className="flex gap-4">
                      <label className="flex items-center cursor-pointer group">
                        <input 
                          type="radio" 
                          name="snack" 
                          value="yes" 
                          checked={formData.snack === 'yes'} 
                          onChange={handleChange}
                          disabled={status === 'submitting'}
                          className="hidden" 
                        />
                        <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center mr-2 ${formData.snack === 'yes' ? 'border-violet-500' : 'border-slate-300 group-hover:border-violet-300'} ${status === 'submitting' ? 'opacity-50' : ''}`}>
                          {formData.snack === 'yes' && <div className="w-2.5 h-2.5 rounded-full bg-violet-500" />}
                        </div>
                        <span className={`${formData.snack === 'yes' ? 'text-slate-800 font-bold' : 'text-slate-500'}`}>是，我需要</span>
                      </label>
                      <label className="flex items-center cursor-pointer group">
                        <input 
                          type="radio" 
                          name="snack" 
                          value="no" 
                          checked={formData.snack === 'no'} 
                          onChange={handleChange}
                          disabled={status === 'submitting'}
                          className="hidden" 
                        />
                         <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center mr-2 ${formData.snack === 'no' ? 'border-violet-500' : 'border-slate-300 group-hover:border-violet-300'} ${status === 'submitting' ? 'opacity-50' : ''}`}>
                          {formData.snack === 'no' && <div className="w-2.5 h-2.5 rounded-full bg-violet-500" />}
                        </div>
                        <span className={`${formData.snack === 'no' ? 'text-slate-800 font-bold' : 'text-slate-500'}`}>不用了，謝謝</span>
                      </label>
                    </div>
                  </div>

                  {/* Questions */}
                  <div>
                    <label className="block text-sm font-bold text-slate-700 mb-1">會前提問</label>
                    <p className="text-xs text-slate-500 mb-2">您目前在行政工作上遇到的困難？或最想了解敏捷的哪個部分？</p>
                    <textarea 
                      name="question"
                      value={formData.question}
                      onChange={handleChange}
                      disabled={status === 'submitting'}
                      rows="3"
                      className="w-full px-4 py-3 rounded-xl bg-slate-50 border-2 border-slate-100 focus:border-violet-500 outline-none transition-all resize-none disabled:opacity-50"
                      placeholder="歡迎留下您的想法..."
                    ></textarea>
                  </div>

                  {/* Privacy Note */}
                  <p className="text-xs text-slate-400 text-center">
                    本報名資料僅供本次研討會聯繫與餐點統計使用。
                  </p>

                  {/* Submit Button */}
                  <button 
                    type="submit" 
                    disabled={status === 'submitting'}
                    className={`w-full py-4 bg-gradient-to-r from-violet-600 to-fuchsia-600 hover:from-violet-700 hover:to-fuchsia-700 text-white font-bold rounded-xl shadow-lg shadow-fuchsia-500/30 transform transition-all duration-200 flex items-center justify-center gap-2 group
                      ${status === 'submitting' ? 'opacity-70 cursor-not-allowed scale-100' : 'hover:scale-[1.02] hover:shadow-xl'}
                    `}
                  >
                    {status === 'submitting' ? (
                      <>
                        <Loader2 className="w-5 h-5 animate-spin" />
                        <span>處理中...</span>
                      </>
                    ) : (
                      <>
                        <span>確認報名</span>
                        <ArrowRight className="w-5 h-5 group-hover:translate-x-1 transition-transform" />
                      </>
                    )}
                  </button>
                </form>
              </div>

              {/* Success Message Card */}
              {status === 'success' && (
                <div className="bg-white rounded-3xl shadow-2xl p-8 text-center animate-in fade-in zoom-in duration-500">
                  <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <CheckCircle className="w-10 h-10 text-green-600" />
                  </div>
                  <h2 className="text-3xl font-bold text-slate-800 mb-2">報名成功！</h2>
                  <p className="text-slate-600 mb-6">
                    感謝您的參與，我們已收到您的資料。<br/>
                    期待當天與您在第五醫療大樓相見！
                  </p>
                  <div className="bg-slate-50 rounded-xl p-4 text-left mb-6">
                    <h4 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">您的資訊</h4>
                    <div className="space-y-1">
                      <p className="text-slate-800 font-medium"><span className="text-slate-400 mr-2">姓名:</span>{formData.name}</p>
                      <p className="text-slate-800 font-medium"><span className="text-slate-400 mr-2">單位:</span>{formData.unit}</p>
                      <p className="text-slate-800 font-medium"><span className="text-slate-400 mr-2">Email:</span>{formData.email}</p>
                    </div>
                  </div>
                  <button 
                    onClick={() => window.print()}
                    className="text-violet-600 font-bold hover:underline"
                  >
                    列印或截圖留存
                  </button>
                </div>
              )}

               {/* Error Message (Optional visual feedback if needed) */}
               {status === 'error' && (
                 <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-xl text-red-600 flex items-center gap-2 animate-in fade-in slide-in-from-top-2">
                   <AlertCircle className="w-5 h-5" />
                   <span>報名發生錯誤，請稍後再試或聯繫主辦單位。</span>
                 </div>
               )}
            </div>
          </div>
        </div>

        {/* Footer */}
        <footer className="mt-20 border-t border-white/20 pt-8 text-center text-white/80 pb-8">
          <p className="font-bold text-lg mb-2">主辦單位：奇美醫院教學部</p>
          <p className="flex items-center justify-center gap-2">
            <User className="w-4 h-4" /> 聯絡人：盧英云 (分機 57425)
          </p>
          <p className="text-sm mt-4 opacity-60">&copy; 2025 Hello World Developer Conference. All rights reserved.</p>
        </footer>

      </div>

      {/* CSS for Blob Animation */}
      <style>{`
        @keyframes blob {
          0% { transform: translate(0px, 0px) scale(1); }
          33% { transform: translate(30px, -50px) scale(1.1); }
          66% { transform: translate(-20px, 20px) scale(0.9); }
          100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob {
          animation: blob 7s infinite;
        }
        .animation-delay-2000 {
          animation-delay: 2s;
        }
        .animation-delay-4000 {
          animation-delay: 4s;
        }
      `}</style>
    </div>
  );
};

export default AgileWorkshop;
