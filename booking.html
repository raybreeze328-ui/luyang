<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ±åç¾æ³å„€è¡¨æ¿ - æ•æ·æ€ç¶­ç ”è¨æœƒ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* è‡ªå®šç¾©è¼‰å…¥å‹•ç•« */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin-custom {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-50 font-sans text-slate-800 pb-12">

    <!-- Dashboard Header -->
    <div class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">ğŸ“Š å ±åç¾æ³å„€è¡¨æ¿</h1>
                <p class="text-sm text-slate-500">æ•æ·æ€ç¶­å°å…¥æ•™å­¸è¡Œæ”¿ç ”è¨æœƒ</p>
            </div>
            <div class="flex gap-3">
                <a href="https://docs.google.com/spreadsheets/d/15WYgMVTklNn3rfcnOsaQtjPYEchnPfA9IX-FxY639aE/edit?gid=0#gid=0" 
                   target="_blank" 
                   class="hidden md:flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium">
                   <i data-lucide="download" class="w-4 h-4"></i>
                   æŸ¥çœ‹åŸå§‹è©¦ç®—è¡¨
                </a>
                <button id="refresh-btn" onclick="fetchData()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                    <i data-lucide="refresh-cw" id="refresh-icon" class="w-4 h-4"></i>
                    <span id="refresh-text">é‡æ–°æ•´ç†</span>
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Card 1: Total Registration -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                <div class="p-4 bg-blue-100 text-blue-600 rounded-xl">
                    <i data-lucide="users" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-500 font-medium">ç¸½å ±åäººæ•¸</p>
                    <h3 class="text-4xl font-bold text-slate-800"><span id="stat-total">0</span> <span class="text-sm font-normal text-slate-400">äºº</span></h3>
                </div>
            </div>

            <!-- Card 2: Snacks -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                <div class="p-4 bg-orange-100 text-orange-600 rounded-xl">
                    <i data-lucide="coffee" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-500 font-medium">èŒ¶é»éœ€æ±‚</p>
                    <div class="flex items-baseline gap-2">
                        <h3 class="text-4xl font-bold text-slate-800" id="stat-snack-yes">0</h3>
                        <span class="text-sm text-green-600 font-medium bg-green-100 px-2 py-0.5 rounded">éœ€è¦</span>
                    </div>
                    <p class="text-xs text-slate-400 mt-1"><span id="stat-snack-no">0</span> äººä¸éœ€è¦</p>
                </div>
            </div>

            <!-- Card 3: Questions -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                <div class="p-4 bg-purple-100 text-purple-600 rounded-xl">
                    <i data-lucide="message-circle" class="w-8 h-8"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-500 font-medium">æœƒå‰æå•æ•¸</p>
                    <h3 class="text-4xl font-bold text-slate-800"><span id="stat-questions">0</span> <span class="text-sm font-normal text-slate-400">å‰‡</span></h3>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            
            <!-- Chart 1: Job Distribution -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="text-lg font-bold text-slate-700 mb-6 border-l-4 border-blue-500 pl-3">åƒåŠ è€…è·ç¨±åˆ†ä½ˆ</h3>
                <div class="h-64 w-full relative">
                    <canvas id="jobChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: Unit Distribution -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h3 class="text-lg font-bold text-slate-700 mb-6 border-l-4 border-green-500 pl-3">ç†±é–€å ±åå–®ä½ (Top 5)</h3>
                <div class="h-64 w-full relative">
                    <canvas id="unitChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Questions Section -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="p-6 border-b border-slate-100">
                <h3 class="text-lg font-bold text-slate-700 border-l-4 border-purple-500 pl-3">æœ€æ–°æœƒå‰æå•</h3>
            </div>
            <div id="questions-list" class="divide-y divide-slate-100">
                <!-- Javascript will populate this -->
                <div class="p-12 text-center text-slate-400">
                    <i data-lucide="loader-2" class="w-12 h-12 mx-auto mb-3 animate-spin-custom text-slate-300"></i>
                    <p>è¼‰å…¥è³‡æ–™ä¸­...</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Logic Script -->
    <script>
        // åˆå§‹åŒ– Icons
        lucide.createIcons();

        // Apps Script URL
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyrCzAWakVPaZUea05G6IRyxc5cX-XW353SwLP6zFk0Tbd7ZL4wZyQfs-ZO1l5iglQT/exec";

        // Chart Instances
        let jobChartInstance = null;
        let unitChartInstance = null;

        // Mock Data (å‚™ç”¨)
        const mockData = [
            { name: "ç‹å°æ˜", unit: "æ•™å­¸éƒ¨", jobTitle: "è¡Œæ”¿äººå“¡", snack: "éœ€è¦", question: "å¦‚ä½•æ¨å‹•?" },
            { name: "æå¤§è¯", unit: "è­·ç†éƒ¨", jobTitle: "è­·ç†å¸«", snack: "ä¸éœ€è¦", question: "" },
            { name: "å¼µç¾ç¾", unit: "æ€¥è¨ºéƒ¨", jobTitle: "é†«å¸«", snack: "éœ€è¦", question: "QCC æ‡‰ç”¨æ¡ˆä¾‹?" },
            { name: "é™³å¿—è±ª", unit: "æ•™å­¸éƒ¨", jobTitle: "è¡Œæ”¿äººå“¡", snack: "éœ€è¦", question: "" },
            { name: "æ—å°é›…", unit: "è—¥åŠ‘éƒ¨", jobTitle: "é†«äº‹äººå“¡", snack: "éœ€è¦", question: "æ•æ·èˆ‡å‚³çµ±ç®¡ç†çš„è¡çª" },
            { name: "é»ƒåœ‹æ¦®", unit: "è³‡è¨Šå®¤", jobTitle: "å…¶ä»–", snack: "ä¸éœ€è¦", question: "" },
            { name: "å³é›…å©·", unit: "è­·ç†éƒ¨", jobTitle: "è­·ç†å¸«", snack: "éœ€è¦", question: "" },
        ];

        async function fetchData() {
            setLoading(true);
            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error("Network response was not ok");
                const jsonData = await response.json();
                
                if (Array.isArray(jsonData)) {
                    processData(jsonData);
                } else {
                    console.warn("Fetched data is not array, using mock data.");
                    processData(mockData); 
                }
            } catch (error) {
                console.error("Fetch error, using mock data for preview:", error);
                // ç‚ºäº†è®“æ‚¨çœ‹åˆ°æ•ˆæœï¼Œå¦‚æœç™¼ç”ŸéŒ¯èª¤ï¼ˆä¾‹å¦‚é è¦½ç’°å¢ƒè·¨åŸŸï¼‰ï¼Œæˆ‘å€‘ä½¿ç”¨æ¨¡æ“¬è³‡æ–™
                processData(mockData);
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            const btnIcon = document.getElementById('refresh-icon');
            const btnText = document.getElementById('refresh-text');
            
            if (isLoading) {
                btnIcon.classList.add('animate-spin-custom');
                btnText.textContent = "æ›´æ–°ä¸­...";
            } else {
                btnIcon.classList.remove('animate-spin-custom');
                btnText.textContent = "é‡æ–°æ•´ç†";
            }
        }

        function processData(rawData) {
            // 1. è¨ˆç®—ç¸½äººæ•¸
            document.getElementById('stat-total').textContent = rawData.length;

            // 2. è¨ˆç®—èŒ¶é»éœ€æ±‚
            let yes = 0;
            let no = 0;
            rawData.forEach(item => {
                if (item.snack && (item.snack.includes('éœ€') || item.snack.toLowerCase() === 'yes')) {
                    yes++;
                } else {
                    no++;
                }
            });
            document.getElementById('stat-snack-yes').textContent = yes;
            document.getElementById('stat-snack-no').textContent = no;

            // 3. è¨ˆç®—è·ç¨±åˆ†ä½ˆ
            const jobCount = {};
            rawData.forEach(item => {
                const job = item.jobTitle || 'æœªå¡«å¯«';
                jobCount[job] = (jobCount[job] || 0) + 1;
            });
            updateJobChart(jobCount);

            // 4. è¨ˆç®—å–®ä½åˆ†ä½ˆ (Top 5)
            const unitCount = {};
            rawData.forEach(item => {
                const unit = item.unit || 'æœªå¡«å¯«';
                unitCount[unit] = (unitCount[unit] || 0) + 1;
            });
            const sortedUnits = Object.keys(unitCount)
                .map(key => ({ name: key, count: unitCount[key] }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);
            updateUnitChart(sortedUnits);

            // 5. ç¯©é¸æå•
            const recentQuestions = rawData
                .filter(item => item.question && item.question.length > 1)
                .slice(-5)
                .reverse();
            document.getElementById('stat-questions').textContent = recentQuestions.length;
            renderQuestions(recentQuestions);
        }

        function updateJobChart(jobCount) {
            const labels = Object.keys(jobCount);
            const data = Object.values(jobCount);
            const ctx = document.getElementById('jobChart').getContext('2d');

            if (jobChartInstance) jobChartInstance.destroy();

            jobChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#8b5cf6', '#ec4899', '#f97316', '#3b82f6', '#10b981', '#6366f1'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function updateUnitChart(sortedUnits) {
            const labels = sortedUnits.map(i => i.name);
            const data = sortedUnits.map(i => i.count);
            const ctx = document.getElementById('unitChart').getContext('2d');

            if (unitChartInstance) unitChartInstance.destroy();

            unitChartInstance = new Chart(ctx, {
                type: 'bar',
                indexAxis: 'y', // æ°´å¹³é•·æ¢åœ–
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å ±åäººæ•¸',
                        data: data,
                        backgroundColor: '#10b981',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }

        function renderQuestions(questions) {
            const list = document.getElementById('questions-list');
            list.innerHTML = ''; // Clear existing

            if (questions.length === 0) {
                list.innerHTML = `
                    <div class="p-12 text-center text-slate-400">
                        <i data-lucide="message-circle" class="w-12 h-12 mx-auto mb-3 opacity-20"></i>
                        <p>ç›®å‰å°šç„¡æå•è³‡æ–™</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            questions.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'p-6 hover:bg-slate-50 transition-colors';
                div.innerHTML = `
                    <div class="flex items-start gap-4">
                        <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 flex-shrink-0 font-bold text-xs">
                            Q${index + 1}
                        </div>
                        <div>
                            <p class="text-slate-800 text-sm font-medium mb-1">${item.question}</p>
                            <p class="text-xs text-slate-400">
                                æå•è€…ï¼š${item.name} (${item.unit})
                            </p>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // åˆå§‹åŸ·è¡Œ
        fetchData();

    </script>
</body>
</html>
